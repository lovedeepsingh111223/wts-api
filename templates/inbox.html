{% extends "layout.html" %}

{% block content %}
<div class="p-6 md:p-10 bg-gray-100 min-h-[75vh] -m-6 md:-m-8 flex">

    <div id="contacts-panel" class="flex-none w-80 bg-white rounded-2xl shadow-xl p-4 overflow-y-auto hidden">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex justify-between items-center">
            Contacts
            <button id="show-inbox-btn" class="text-sm text-blue-600 hover:underline">Show Inbox</button>
        </h2>
        
        <div class="mb-4">
            <input type="text" id="contact-search" placeholder="Search contacts..." class="w-full px-3 py-1 rounded border focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div class="border-b pb-4 mb-4">
            <h4 class="font-semibold text-gray-700 mb-2">Add New Contact</h4>
            <input type="text" id="new-contact-phone" placeholder="Phone Number" class="w-full mb-2 px-3 py-1 rounded border">
            <input type="text" id="new-contact-name" placeholder="Name" class="w-full mb-2 px-3 py-1 rounded border">
            <input type="email" id="new-contact-email" placeholder="Email (optional)" class="w-full mb-2 px-3 py-1 rounded border">
            <input type="text" id="new-contact-city" placeholder="City (optional)" class="w-full mb-2 px-3 py-1 rounded border">
            <input type="text" id="new-contact-tags" placeholder="Tags (e.g., Lead, VIP)" class="w-full mb-2 px-3 py-1 rounded border">
            <button id="add-contact-btn" class="w-full bg-green-500 text-white py-1 rounded hover:bg-green-600 transition">Add</button>
        </div>

        <div id="contacts-list" class="space-y-2">
            <div class="text-center text-gray-500 py-10">Loading contacts...</div>
        </div>
    </div>

    <div id="inbox-panel" class="flex-1 bg-white rounded-2xl shadow-xl flex flex-col">
        <div class="flex items-center justify-between p-4 border-b border-gray-200">
            <h3 class="text-xl font-bold text-gray-800" id="chat-contact-name">Select a chat</h3>
            <button id="show-contacts-btn" class="bg-gray-200 text-gray-700 text-sm px-3 py-1 rounded-full hover:bg-gray-300">Manage Contacts</button>
        </div>

        <div class="flex-1 p-6 overflow-y-auto" id="message-history-area">
            <div class="text-center text-gray-500 py-20" id="no-messages-msg">No messages yet. Start a conversation.</div>
        </div>

        <div class="p-4 border-t border-gray-200 flex items-center gap-2">
            <input type="text" id="message-input" placeholder="Type a message..." class="flex-1 px-4 py-2 rounded-full bg-gray-100 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button id="send-message-btn" class="bg-blue-600 text-white px-6 py-2 rounded-full font-semibold hover:bg-blue-700 transition">Send</button>
        </div>
    </div>
</div>

<div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl w-96">
        <h3 class="text-xl font-bold mb-4">Edit Contact</h3>
        <input type="hidden" id="edit-contact-phone-original">
        <div class="mb-4">
            <label class="block text-gray-700">Phone Number</label>
            <input type="text" id="edit-contact-phone" class="w-full px-3 py-2 rounded border bg-gray-100 cursor-not-allowed" readonly>
        </div>
        <div class="mb-4">
            <label class="block text-gray-700">Name</label>
            <input type="text" id="edit-contact-name" class="w-full px-3 py-2 rounded border">
        </div>
        <div class="mb-4">
            <label class="block text-gray-700">Email</label>
            <input type="email" id="edit-contact-email" class="w-full px-3 py-2 rounded border">
        </div>
        <div class="mb-4">
            <label class="block text-gray-700">City</label>
            <input type="text" id="edit-contact-city" class="w-full px-3 py-2 rounded border">
        </div>
        <div class="mb-4">
            <label class="block text-gray-700">Tags</label>
            <input type="text" id="edit-contact-tags" class="w-full px-3 py-2 rounded border">
        </div>
        <div class="mb-4">
            <label class="block text-gray-700">Notes</label>
            <textarea id="edit-contact-notes" rows="3" class="w-full px-3 py-2 rounded border"></textarea>
        </div>
        <div class="flex justify-end gap-2">
            <button id="save-edit-btn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">Save Changes</button>
            <button id="cancel-edit-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400 transition">Cancel</button>
        </div>
    </div>
</div>

<div id="confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center hidden z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl w-96">
        <h3 class="text-xl font-bold mb-4">Confirm Deletion</h3>
        <p id="confirm-message" class="text-gray-700 mb-6">Are you sure you want to delete this contact?</p>
        <div class="flex justify-end gap-2">
            <button id="confirm-yes-btn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition">Delete</button>
            <button id="confirm-no-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400 transition">Cancel</button>
        </div>
    </div>
</div>

<div id="success-toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-full shadow-lg z-50 transition-all duration-300 transform translate-y-20 opacity-0">
    <p id="toast-message">Success!</p>
</div>


<script>
    const chatList = document.getElementById('chat-list');
    const messagePanel = document.getElementById('message-panel');
    const chatContactName = document.getElementById('chat-contact-name');
    const messageHistoryArea = document.getElementById('message-history-area');
    const noMessagesMsg = document.getElementById('no-messages-msg');
    const messageInput = document.getElementById('message-input');
    const sendMessageBtn = document.getElementById('send-message-btn');

    // --- Elements for Contact Management ---
    const contactsPanel = document.getElementById('contacts-panel');
    const inboxPanel = document.getElementById('inbox-panel');
    const showContactsBtn = document.getElementById('show-contacts-btn');
    const showInboxBtn = document.getElementById('show-inbox-btn');
    const contactsListDiv = document.getElementById('contacts-list');
    const addContactBtn = document.getElementById('add-contact-btn');
    const newContactPhoneInput = document.getElementById('new-contact-phone');
    const newContactNameInput = document.getElementById('new-contact-name');
    const newContactEmailInput = document.getElementById('new-contact-email');
    const newContactCityInput = document.getElementById('new-contact-city');
    const newContactTagsInput = document.getElementById('new-contact-tags');
    const contactSearchInput = document.getElementById('contact-search');

    // --- Elements for Edit Modal ---
    const editModal = document.getElementById('edit-modal');
    const editContactPhoneOriginal = document.getElementById('edit-contact-phone-original');
    const editContactPhoneInput = document.getElementById('edit-contact-phone');
    const editContactNameInput = document.getElementById('edit-contact-name');
    const editContactEmailInput = document.getElementById('edit-contact-email');
    const editContactCityInput = document.getElementById('edit-contact-city');
    const editContactTagsInput = document.getElementById('edit-contact-tags');
    const editContactNotesInput = document.getElementById('edit-contact-notes');
    const saveEditBtn = document.getElementById('save-edit-btn');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    
    // NEW: Elements for Confirmation Modal
    const confirmModal = document.getElementById('confirm-modal');
    const confirmMessage = document.getElementById('confirm-message');
    const confirmYesBtn = document.getElementById('confirm-yes-btn');
    const confirmNoBtn = document.getElementById('confirm-no-btn');
    
    // NEW: Elements for Success Toast
    const successToast = document.getElementById('success-toast');
    const toastMessage = document.getElementById('toast-message');

    let currentChatNumber = null;
    let allContacts = []; // Store all contacts

    // Helper function to format timestamp
    function formatTimestamp(isoString) {
        const date = new Date(isoString);
        return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
    }
    
    // NEW: Function to show the success toast
    function showSuccessToast(message) {
        toastMessage.textContent = message;
        successToast.classList.remove('translate-y-20', 'opacity-0');
        successToast.classList.add('translate-y-0', 'opacity-100');
        setTimeout(() => {
            successToast.classList.remove('translate-y-0', 'opacity-100');
            successToast.classList.add('translate-y-20', 'opacity-0');
        }, 3000); // Hide after 3 seconds
    }
    
    // NEW: Function to show the confirmation modal
    function showConfirmModal(message, onConfirm) {
        confirmMessage.textContent = message;
        confirmModal.classList.remove('hidden');
        confirmYesBtn.onclick = () => {
            confirmModal.classList.add('hidden');
            onConfirm();
        };
        confirmNoBtn.onclick = () => {
            confirmModal.classList.add('hidden');
        };
    }

    // Function to fetch and display chat list (polling ke saath)
    async function fetchChatList() {
        try {
            const response = await fetch('/api/chats');
            const chats = await response.json();
            
            chatList.innerHTML = '';
            if (chats.length === 0) {
                chatList.innerHTML = '<div class="text-center text-gray-500 py-10">No conversations yet.</div>';
                return;
            }
            
            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.classList.add('p-3', 'rounded-lg', 'hover:bg-gray-50', 'cursor-pointer', 'flex', 'flex-col');
                chatItem.dataset.phoneNumber = chat.phone_number;
                chatItem.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-semibold text-gray-800 text-lg">${chat.phone_number}</span>
                        <span class="text-xs text-gray-500">${formatTimestamp(chat.timestamp)}</span>
                    </div>
                    <p class="text-sm text-gray-600 truncate">${chat.isFromMe ? 'You: ' : ''}${chat.last_message}</p>
                `;
                chatList.appendChild(chatItem);
                chatItem.addEventListener('click', () => loadChat(chat.phone_number));
            });

            if (chats.length > 0 && !currentChatNumber) {
                loadChat(chats[0].phone_number);
            }
        } catch (error) {
            console.error('Error fetching chat list:', error);
            chatList.innerHTML = '<div class="text-center text-red-500 py-10">Failed to load chats.</div>';
        }
    }

    // Function to load and display messages for a specific chat
    async function loadChat(phoneNumber) {
        currentChatNumber = phoneNumber;
        chatContactName.textContent = phoneNumber;
        messageHistoryArea.innerHTML = '';
        noMessagesMsg.classList.add('hidden');

        document.querySelectorAll('#chat-list > div').forEach(item => {
            item.classList.remove('bg-gray-100');
            if (item.dataset.phoneNumber === phoneNumber) {
                item.classList.add('bg-gray-100');
            }
        });

        try {
            const response = await fetch(`/api/chats/${phoneNumber}`);
            const messages = await response.json();
            
            if (messages.length === 0) {
                noMessagesMsg.classList.remove('hidden');
                return;
            }

            messages.forEach(msg => {
                const isFromMe = msg.isFromMe;
                const messageBubble = document.createElement('div');
                messageBubble.classList.add('flex', 'mb-4', isFromMe ? 'justify-end' : 'justify-start');
                
                messageBubble.innerHTML = `
                    <div class="${isFromMe ? 'bg-blue-600 text-white rounded-br-none' : 'bg-gray-200 text-gray-800 rounded-bl-none'} max-w-sm p-3 rounded-lg shadow">
                        <p class="text-sm">${msg.text}</p>
                        <span class="block text-xs mt-1 text-right ${isFromMe ? 'text-gray-200' : 'text-gray-500'}">${formatTimestamp(msg.timestamp)}</span>
                    </div>
                `;
                messageHistoryArea.appendChild(messageBubble);
            });
            messageHistoryArea.scrollTop = messageHistoryArea.scrollHeight;
        } catch (error) {
            console.error('Error fetching chat history:', error);
            messageHistoryArea.innerHTML = '<div class="text-center text-red-500 py-10">Failed to load messages.</div>';
        }
    }

    // Function to send a new message
    async function sendMessage() {
        const messageBody = messageInput.value.trim();
        if (!messageBody || !currentChatNumber) return;

        try {
            const response = await fetch('/api/send_message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    to_number: currentChatNumber,
                    message_body: messageBody
                })
            });

            if (response.ok) {
                const sentMessage = { text: messageBody, timestamp: new Date().toISOString(), isFromMe: true };
                const messageBubble = document.createElement('div');
                messageBubble.classList.add('flex', 'mb-4', 'justify-end');
                messageBubble.innerHTML = `
                    <div class="bg-blue-600 text-white rounded-br-none max-w-sm p-3 rounded-lg shadow">
                        <p class="text-sm">${sentMessage.text}</p>
                        <span class="block text-xs mt-1 text-right text-gray-200">${formatTimestamp(sentMessage.timestamp)}</span>
                    </div>
                `;
                messageHistoryArea.appendChild(messageBubble);
                messageInput.value = '';
                messageHistoryArea.scrollTop = messageHistoryArea.scrollHeight;
            } else {
                alert('Failed to send message.');
            }
        } catch (error) {
            console.error('Error sending message:', error);
            alert('An error occurred while sending the message.');
        }
    }

    // --- New JavaScript for Contact Management ---

    // Contacts ko fetch aur display karne ka function
    async function fetchContacts() {
        try {
            const response = await fetch('/api/contacts');
            allContacts = await response.json(); // Sabhi contacts ko store kar rahe hain
            displayContacts(allContacts);
        } catch (error) {
            console.error('Error fetching contacts:', error);
            contactsListDiv.innerHTML = '<div class="text-center text-red-500 py-10">Failed to load contacts.</div>';
        }
    }
    
    // Contacts ko display karne ka function (search filter ke saath)
    function displayContacts(contactsToDisplay) {
        contactsListDiv.innerHTML = '';
        if (contactsToDisplay.length === 0) {
            contactsListDiv.innerHTML = '<div class="text-center text-gray-500 py-10">No contacts found.</div>';
            return;
        }
        contactsToDisplay.forEach(contact => {
            const contactItem = document.createElement('div');
            contactItem.classList.add('p-3', 'rounded-lg', 'hover:bg-gray-50', 'flex', 'flex-col', 'gap-1', 'group');
            contactItem.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-800">${contact.name}</span>
                    <span class="text-sm text-gray-600">${contact.phone_number}</span>
                </div>
                <div class="flex justify-between items-center text-sm text-gray-500">
                    <span class="truncate pr-2">${contact.email || 'No email'}</span>
                    <div class="flex gap-2">
                        <button class="edit-btn text-blue-500 hover:text-blue-700 transition" data-phone="${contact.phone_number}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                              <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <button class="delete-btn text-red-500 hover:text-red-700 transition" data-phone="${contact.phone_number}">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 102 0v6a1 1 0 10-2 0V8z" clip-rule="evenodd" />
                           </svg>
                        </button>
                    </div>
                </div>
            `;
            contactsListDiv.appendChild(contactItem);
        });
    }

    // Function to add a new contact
    async function addContact() {
        const phoneNumber = newContactPhoneInput.value.trim();
        const name = newContactNameInput.value.trim();
        const email = newContactEmailInput.value.trim();
        const city = newContactCityInput.value.trim();
        const tags = newContactTagsInput.value.trim();
        if (!phoneNumber || !name) {
            alert('Phone number and name are required.');
            return;
        }

        try {
            const response = await fetch('/api/contacts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phone_number: phoneNumber, name: name, email: email, city: city, tags: tags })
            });
            const result = await response.json();
            
            // NEW: Use custom success pop-up
            if (result.status === 'success') {
                showSuccessToast(result.message);
                newContactPhoneInput.value = '';
                newContactNameInput.value = '';
                newContactEmailInput.value = '';
                newContactCityInput.value = '';
                newContactTagsInput.value = '';
                fetchContacts();
            } else {
                alert(result.message); // Fallback to alert for errors
            }
        } catch (error) {
            console.error('Error adding contact:', error);
            alert('An error occurred while adding the contact.');
        }
    }

    // Function to update a contact
    async function updateContact() {
        const originalPhone = editContactPhoneOriginal.value;
        const newName = editContactNameInput.value;
        const newEmail = editContactEmailInput.value;
        const newCity = editContactCityInput.value;
        const newTags = editContactTagsInput.value;
        const newNotes = editContactNotesInput.value;

        try {
            const response = await fetch(`/api/contacts/${originalPhone}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: newName,
                    email: newEmail,
                    city: newCity,
                    tags: newTags,
                    notes: newNotes
                })
            });
            const result = await response.json();
            
            // NEW: Use custom success pop-up
            if (result.status === 'success') {
                showSuccessToast(result.message);
                editModal.classList.add('hidden');
                fetchContacts();
            } else {
                alert(result.message); // Fallback to alert for errors
            }
        } catch (error) {
            console.error('Error updating contact:', error);
            alert('An error occurred while updating the contact.');
        }
    }

    // Function to delete a contact
    async function deleteContact(phoneNumber) {
        // NEW: Use custom confirmation modal instead of browser's confirm()
        showConfirmModal(`Are you sure you want to delete contact ${phoneNumber}?`, async () => {
            try {
                const response = await fetch(`/api/contacts/${phoneNumber}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                // NEW: Use custom success pop-up
                if (result.status === 'success') {
                    showSuccessToast(result.message);
                    fetchContacts();
                } else {
                    alert(result.message); // Fallback for errors
                }
            } catch (error) {
                console.error('Error deleting contact:', error);
                alert('An error occurred while deleting the contact.');
            }
        });
    }
    
    // --- Event Listeners ---
    sendMessageBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // New event listeners for Contact Management
    showContactsBtn.addEventListener('click', () => {
        inboxPanel.classList.add('hidden');
        contactsPanel.classList.remove('hidden');
        fetchContacts();
    });
    
    showInboxBtn.addEventListener('click', () => {
        contactsPanel.classList.add('hidden');
        inboxPanel.classList.remove('hidden');
    });

    addContactBtn.addEventListener('click', addContact);
    
    // Event listener for search input
    contactSearchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filteredContacts = allContacts.filter(contact =>
            contact.name.toLowerCase().includes(searchTerm) ||
            contact.phone_number.includes(searchTerm)
        );
        displayContacts(filteredContacts);
    });

    // Event delegation for edit and delete buttons
    contactsListDiv.addEventListener('click', (e) => {
        if (e.target.closest('.delete-btn')) {
            const btn = e.target.closest('.delete-btn');
            const phoneNumber = btn.dataset.phone;
            deleteContact(phoneNumber);
        }
        if (e.target.closest('.edit-btn')) {
            const btn = e.target.closest('.edit-btn');
            const phoneNumber = btn.dataset.phone;
            const contactToEdit = allContacts.find(c => c.phone_number === phoneNumber);
            if (contactToEdit) {
                editContactPhoneOriginal.value = contactToEdit.phone_number;
                editContactPhoneInput.value = contactToEdit.phone_number;
                editContactNameInput.value = contactToEdit.name;
                editContactEmailInput.value = contactToEdit.email;
                editContactCityInput.value = contactToEdit.city;
                editContactTagsInput.value = contactToEdit.tags;
                editContactNotesInput.value = contactToEdit.notes;
                editModal.classList.remove('hidden');
            }
        }
    });

    saveEditBtn.addEventListener('click', updateContact);
    cancelEditBtn.addEventListener('click', () => {
        editModal.classList.add('hidden');
    });

    // Automatically refresh inbox every 5 seconds
    setInterval(fetchChatList, 5000);

    // Initial page load
    fetchChatList();
</script>
{% endblock %}