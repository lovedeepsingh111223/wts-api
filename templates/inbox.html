{% extends "layout.html" %}

{% block content %}
<style>
    :root {
        --primary: #4361ee;
        --primary-dark: #3a56d4;
        --secondary: #f8f9fa;
        --background: #f0f2f5;
        --card-bg: #ffffff;
        --text-primary: #050505;
        --text-secondary: #65676b;
        --border: #e4e6eb;
        --success: #4caf50;
        --warning: #ff9800;
        --danger: #f44336;
        --accent: #8a85ff;
        --hover-bg: #f5f7fb;
        --message-self: #d9fdd3;
        --message-other: #ffffff;
        --online: #31a24c;
        --unread: #e6f7ff;
    }

    .bg-gray-100 {
        background-color: var(--background);
    }

    /* Main container */
    .inbox-container {
        display: flex;
        min-height: 75vh;
        max-height: calc(100vh - 150px);
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        background: var(--card-bg);
    }

    /* Contacts panel */
    #contacts-panel {
        flex: 0 0 320px;
        display: flex;
        flex-direction: column;
        background: var(--card-bg);
        border-right: 1px solid var(--border);
        transition: all 0.3s ease;
        z-index: 10;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.03);
    }

    #contacts-panel.hidden {
        transform: translateX(-100%);
        opacity: 0;
        position: absolute;
        height: 100%;
    }

    .contacts-header {
        padding: 18px 20px;
        border-bottom: 1px solid var(--border);
    }

    .contacts-header h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .add-contact-section {
        padding: 20px;
        border-bottom: 1px solid var(--border);
    }

    .add-contact-section h4 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 16px;
    }

    /* Input styling */
    .form-input {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.2s;
        margin-bottom: 12px;
        background: var(--secondary);
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
    }

    #add-contact-btn {
        background-color: var(--success);
        color: white;
        padding: 10px;
        border-radius: 8px;
        font-weight: 500;
        transition: background-color 0.2s;
        margin-top: 8px;
    }

    #add-contact-btn:hover {
        background-color: #3d8b40;
    }

    /* Contact list */
    #contacts-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
    }

    .contact-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        border-radius: 10px;
        margin-bottom: 8px;
        transition: background-color 0.2s;
        cursor: pointer;
    }

    .contact-item:hover {
        background-color: var(--hover-bg);
    }

    .contact-avatar {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 16px;
        flex-shrink: 0;
        margin-right: 14px;
    }

    .contact-info {
        flex: 1;
        min-width: 0;
    }

    .contact-name {
        font-weight: 600;
        font-size: 15px;
        color: var(--text-primary);
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .contact-details {
        display: flex;
        font-size: 13px;
        color: var(--text-secondary);
    }

    .contact-phone {
        margin-right: 12px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .contact-actions {
        display: flex;
        gap: 12px;
    }

    .contact-actions button {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        transition: color 0.2s;
        font-size: 16px;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .contact-actions button:hover {
        background: var(--hover-bg);
    }

    .edit-btn:hover {
        color: var(--primary);
    }

    .delete-btn:hover {
        color: var(--danger);
    }

    /* Inbox panel */
    #inbox-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: var(--background);
        background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23e5e5e5' fill-opacity='0.2' fill-rule='evenodd'/%3E%3C/svg%3E");
    }

    .chat-header {
        padding: 16px 24px;
        background: var(--card-bg);
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid var(--border);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
    }

    #chat-contact-name {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .online-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: var(--online);
    }

    #show-contacts-btn {
        background-color: var(--primary);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    #show-contacts-btn:hover {
        background-color: var(--primary-dark);
    }

    #show-contacts-btn i {
        font-size: 16px;
    }

    /* Message area */
    #message-history-area {
        flex: 1;
        padding: 20px 15% 10px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .message {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 18px;
        position: relative;
        animation: fadeIn 0.3s ease-out;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        font-size: 15px;
        line-height: 1.4;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .message-self {
        align-self: flex-end;
        background-color: var(--message-self);
        border-bottom-right-radius: 5px;
    }

    .message-other {
        align-self: flex-start;
        background-color: var(--message-other);
        border-bottom-left-radius: 5px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05);
    }

    .message-time {
        text-align: right;
        font-size: 11px;
        margin-top: 6px;
        color: var(--text-secondary);
        opacity: 0.8;
    }

    #no-messages-msg {
        color: var(--text-secondary);
        font-size: 16px;
    }

    /* Message input area */
    .message-input-container {
        padding: 16px 24px;
        background: var(--card-bg);
        display: flex;
        align-items: center;
        gap: 12px;
        border-top: 1px solid var(--border);
    }

    #message-input {
        flex: 1;
        padding: 12px 20px;
        border-radius: 24px;
        background: var(--secondary);
        border: 1px solid var(--border);
        font-size: 15px;
        transition: all 0.2s;
    }

    #message-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
    }

    #send-message-btn {
        background-color: var(--primary);
        color: white;
        padding: 10px 24px;
        border-radius: 24px;
        font-weight: 500;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    #send-message-btn:hover {
        background-color: var(--primary-dark);
    }

    /* Modals */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
    }

    .modal.active {
        opacity: 1;
        visibility: visible;
    }

    .modal-content {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        width: 100%;
        max-width: 440px;
        overflow: hidden;
        transform: translateY(20px);
        transition: transform 0.3s;
    }

    .modal.active .modal-content {
        transform: translateY(0);
    }

    .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border);
    }

    .modal-header h3 {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .modal-body {
        padding: 24px;
    }

    .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }

    .btn {
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
    }

    .btn-primary {
        background-color: var(--primary);
        color: white;
    }

    .btn-primary:hover {
        background-color: var(--primary-dark);
    }

    .btn-secondary {
        background-color: var(--secondary);
        color: var(--text-primary);
    }

    .btn-secondary:hover {
        background-color: #e5e5e5;
    }

    .btn-danger {
        background-color: var(--danger);
        color: white;
    }

    .btn-danger:hover {
        background-color: #d32f2f;
    }

    /* Toast */
    #success-toast {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: var(--success);
        color: white;
        padding: 14px 28px;
        border-radius: 30px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 2000;
        opacity: 0;
        transition: all 0.3s ease;
    }

    #success-toast.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .inbox-container {
            flex-direction: column;
            max-height: calc(100vh - 120px);
        }

        #contacts-panel {
            flex: 0 0 100%;
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 100%;
            z-index: 100;
        }

        #contacts-panel.hidden {
            transform: translateX(-100%);
        }

        #inbox-panel {
            min-height: 100%;
        }

        #message-history-area {
            padding: 15px 10px;
        }

        .message {
            max-width: 85%;
        }
    }
</style>

<div class="p-6 md:p-10 bg-gray-100 min-h-[75vh] -m-6 md:-m-8">
    <div class="inbox-container">
        <!-- Contacts Panel -->
        <div id="contacts-panel" class="hidden">
            <div class="contacts-header">
                <h2>
                    Contacts
                    <button id="show-inbox-btn" class="text-blue-600 hover:underline flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Inbox
                    </button>
                </h2>
            </div>
            
            <div class="px-4 pt-2 pb-4">
                <input type="text" id="contact-search" placeholder="Search contacts..." class="form-input">
            </div>

            <div class="add-contact-section">
                <h4>Add New Contact</h4>
                <input type="text" id="new-contact-phone" placeholder="Phone Number" class="form-input">
                <input type="text" id="new-contact-name" placeholder="Name" class="form-input">
                <input type="email" id="new-contact-email" placeholder="Email (optional)" class="form-input">
                <input type="text" id="new-contact-city" placeholder="City (optional)" class="form-input">
                <input type="text" id="new-contact-tags" placeholder="Tags (e.g., Lead, VIP)" class="form-input">
                <button id="add-contact-btn" class="w-full btn">
                    <i class="fas fa-plus mr-2"></i> Add Contact
                </button>
            </div>

            <div id="contacts-list" class="space-y-2">
                <div class="text-center text-gray-500 py-10">Loading contacts...</div>
            </div>
        </div>

        <!-- Inbox Panel -->
        <div id="inbox-panel" class="flex-1">
            <div class="chat-header">
                <h3 id="chat-contact-name">
                    <span class="online-indicator"></span>
                    Select a chat
                </h3>
                <button id="show-contacts-btn" class="btn">
                    <i class="fas fa-address-book"></i> Manage Contacts
                </button>
            </div>

            <div class="flex-1 p-6 overflow-y-auto" id="message-history-area">
                <div class="text-center text-gray-500 py-20" id="no-messages-msg">
                    <i class="fas fa-comments text-4xl mb-4"></i>
                    <p>No messages yet. Start a conversation.</p>
                </div>
            </div>

            <div class="message-input-container">
                <input type="text" id="message-input" placeholder="Type a message...">
                <button id="send-message-btn" class="btn btn-primary">
                    <i class="fas fa-paper-plane mr-2"></i> Send
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Contact Modal -->
<div id="edit-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Contact</h3>
        </div>
        <div class="modal-body">
            <input type="hidden" id="edit-contact-phone-original">
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Phone Number</label>
                <input type="text" id="edit-contact-phone" class="form-input bg-gray-100 cursor-not-allowed" readonly>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Name</label>
                <input type="text" id="edit-contact-name" class="form-input">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Email</label>
                <input type="email" id="edit-contact-email" class="form-input">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">City</label>
                <input type="text" id="edit-contact-city" class="form-input">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Tags</label>
                <input type="text" id="edit-contact-tags" class="form-input">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Notes</label>
                <textarea id="edit-contact-notes" rows="3" class="form-input"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button id="cancel-edit-btn" class="btn btn-secondary">Cancel</button>
            <button id="save-edit-btn" class="btn btn-primary">Save Changes</button>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirm-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Confirm Deletion</h3>
        </div>
        <div class="modal-body">
            <p id="confirm-message" class="text-gray-700">Are you sure you want to delete this contact?</p>
        </div>
        <div class="modal-footer">
            <button id="confirm-no-btn" class="btn btn-secondary">Cancel</button>
            <button id="confirm-yes-btn" class="btn btn-danger">Delete</button>
        </div>
    </div>
</div>

<!-- Success Toast -->
<div id="success-toast">
    <i class="fas fa-check-circle"></i>
    <p id="toast-message">Success!</p>
</div>

<script>
    // Add Font Awesome for icons
    document.head.innerHTML += '<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">';

    // Existing JavaScript with minor updates for new class names
    const chatList = document.getElementById('chat-list');
    const chatContactName = document.getElementById('chat-contact-name');
    const messageHistoryArea = document.getElementById('message-history-area');
    const noMessagesMsg = document.getElementById('no-messages-msg');
    const messageInput = document.getElementById('message-input');
    const sendMessageBtn = document.getElementById('send-message-btn');

    // Elements for Contact Management
    const contactsPanel = document.getElementById('contacts-panel');
    const inboxPanel = document.getElementById('inbox-panel');
    const showContactsBtn = document.getElementById('show-contacts-btn');
    const showInboxBtn = document.getElementById('show-inbox-btn');
    const contactsListDiv = document.getElementById('contacts-list');
    const addContactBtn = document.getElementById('add-contact-btn');
    const newContactPhoneInput = document.getElementById('new-contact-phone');
    const newContactNameInput = document.getElementById('new-contact-name');
    const newContactEmailInput = document.getElementById('new-contact-email');
    const newContactCityInput = document.getElementById('new-contact-city');
    const newContactTagsInput = document.getElementById('new-contact-tags');
    const contactSearchInput = document.getElementById('contact-search');

    // Elements for Edit Modal
    const editModal = document.getElementById('edit-modal');
    const editContactPhoneOriginal = document.getElementById('edit-contact-phone-original');
    const editContactPhoneInput = document.getElementById('edit-contact-phone');
    const editContactNameInput = document.getElementById('edit-contact-name');
    const editContactEmailInput = document.getElementById('edit-contact-email');
    const editContactCityInput = document.getElementById('edit-contact-city');
    const editContactTagsInput = document.getElementById('edit-contact-tags');
    const editContactNotesInput = document.getElementById('edit-contact-notes');
    const saveEditBtn = document.getElementById('save-edit-btn');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    
    // Elements for Confirmation Modal
    const confirmModal = document.getElementById('confirm-modal');
    const confirmMessage = document.getElementById('confirm-message');
    const confirmYesBtn = document.getElementById('confirm-yes-btn');
    const confirmNoBtn = document.getElementById('confirm-no-btn');
    
    // Elements for Success Toast
    const successToast = document.getElementById('success-toast');
    const toastMessage = document.getElementById('toast-message');

    let currentChatNumber = null;
    let allContacts = []; // Store all contacts

    // Helper function to format timestamp
    function formatTimestamp(isoString) {
        const date = new Date(isoString);
        return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
    }
    
    // Function to show the success toast
    function showSuccessToast(message) {
        toastMessage.textContent = message;
        successToast.classList.add('show');
        setTimeout(() => {
            successToast.classList.remove('show');
        }, 3000); // Hide after 3 seconds
    }
    
    // Function to show the confirmation modal
    function showConfirmModal(message, onConfirm) {
        confirmMessage.textContent = message;
        confirmModal.classList.add('active');
        confirmYesBtn.onclick = () => {
            confirmModal.classList.remove('active');
            onConfirm();
        };
        confirmNoBtn.onclick = () => {
            confirmModal.classList.remove('active');
        };
    }
    
    // Function to show modal
    function showModal(modal) {
        modal.classList.add('active');
    }
    
    // Function to hide modal
    function hideModal(modal) {
        modal.classList.remove('active');
    }

    // Function to fetch and display chat list
    async function fetchChatList() {
        try {
            const response = await fetch('/api/chats');
            const chats = await response.json();
            
            chatList.innerHTML = '';
            if (chats.length === 0) {
                chatList.innerHTML = '<div class="text-center text-gray-500 py-10">No conversations yet.</div>';
                return;
            }
            
            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.classList.add('contact-item');
                chatItem.dataset.phoneNumber = chat.phone_number;
                
                // Generate initials for avatar
                const nameParts = chat.phone_number.replace(/[^a-zA-Z ]/g, "").split(' ');
                let initials = '';
                if (nameParts.length > 0) {
                    initials = nameParts[0].charAt(0);
                    if (nameParts.length > 1) {
                        initials += nameParts[1].charAt(0);
                    }
                } else {
                    initials = chat.phone_number.substring(0, 2);
                }
                
                chatItem.innerHTML = `
                    <div class="contact-avatar">${initials}</div>
                    <div class="contact-info">
                        <div class="contact-name">${chat.phone_number}</div>
                        <div class="contact-details">
                            <div class="contact-preview">${chat.isFromMe ? 'You: ' : ''}${chat.last_message}</div>
                        </div>
                    </div>
                    <div class="contact-time">${formatTimestamp(chat.timestamp)}</div>
                `;
                chatList.appendChild(chatItem);
                chatItem.addEventListener('click', () => loadChat(chat.phone_number));
            });

            if (chats.length > 0 && !currentChatNumber) {
                loadChat(chats[0].phone_number);
            }
        } catch (error) {
            console.error('Error fetching chat list:', error);
            chatList.innerHTML = '<div class="text-center text-red-500 py-10">Failed to load chats.</div>';
        }
    }

    // Function to load and display messages for a specific chat
    async function loadChat(phoneNumber) {
        currentChatNumber = phoneNumber;
        chatContactName.innerHTML = `<span class="online-indicator"></span>${phoneNumber}`;
        messageHistoryArea.innerHTML = '';
        noMessagesMsg.classList.add('hidden');

        document.querySelectorAll('#chat-list > div').forEach(item => {
            item.classList.remove('bg-gray-100');
            if (item.dataset.phoneNumber === phoneNumber) {
                item.classList.add('bg-gray-100');
            }
        });

        try {
            const response = await fetch(`/api/chats/${phoneNumber}`);
            const messages = await response.json();
            
            if (messages.length === 0) {
                noMessagesMsg.classList.remove('hidden');
                return;
            }

            messages.forEach(msg => {
                const isFromMe = msg.isFromMe;
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', isFromMe ? 'message-self' : 'message-other');
                
                messageDiv.innerHTML = `
                    <div class="message-content">${msg.text}</div>
                    <div class="message-time">${formatTimestamp(msg.timestamp)}</div>
                `;
                messageHistoryArea.appendChild(messageDiv);
            });
            messageHistoryArea.scrollTop = messageHistoryArea.scrollHeight;
        } catch (error) {
            console.error('Error fetching chat history:', error);
            messageHistoryArea.innerHTML = '<div class="text-center text-red-500 py-10">Failed to load messages.</div>';
        }
    }

    // Function to send a new message
    async function sendMessage() {
        const messageBody = messageInput.value.trim();
        if (!messageBody || !currentChatNumber) return;

        try {
            const response = await fetch('/api/send_message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    to_number: currentChatNumber,
                    message_body: messageBody
                })
            });

            if (response.ok) {
                const sentMessage = { text: messageBody, timestamp: new Date().toISOString(), isFromMe: true };
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', 'message-self');
                messageDiv.innerHTML = `
                    <div class="message-content">${sentMessage.text}</div>
                    <div class="message-time">${formatTimestamp(sentMessage.timestamp)}</div>
                `;
                messageHistoryArea.appendChild(messageDiv);
                messageInput.value = '';
                messageHistoryArea.scrollTop = messageHistoryArea.scrollHeight;
            } else {
                alert('Failed to send message.');
            }
        } catch (error) {
            console.error('Error sending message:', error);
            alert('An error occurred while sending the message.');
        }
    }

    // Contacts fetch and display
    async function fetchContacts() {
        try {
            const response = await fetch('/api/contacts');
            allContacts = await response.json();
            displayContacts(allContacts);
        } catch (error) {
            console.error('Error fetching contacts:', error);
            contactsListDiv.innerHTML = '<div class="text-center text-red-500 py-10">Failed to load contacts.</div>';
        }
    }
    
    // Display contacts
    function displayContacts(contactsToDisplay) {
        contactsListDiv.innerHTML = '';
        if (contactsToDisplay.length === 0) {
            contactsListDiv.innerHTML = '<div class="text-center text-gray-500 py-10">No contacts found.</div>';
            return;
        }
        
        contactsToDisplay.forEach(contact => {
            const contactItem = document.createElement('div');
            contactItem.classList.add('contact-item');
            
            // Generate initials for avatar
            const nameParts = contact.name.split(' ');
            let initials = '';
            if (nameParts.length > 0) {
                initials = nameParts[0].charAt(0);
                if (nameParts.length > 1) {
                    initials += nameParts[1].charAt(0);
                }
            } else {
                initials = contact.phone_number.substring(0, 2);
            }
            
            contactItem.innerHTML = `
                <div class="contact-avatar">${initials}</div>
                <div class="contact-info">
                    <div class="contact-name">${contact.name}</div>
                    <div class="contact-details">
                        <div class="contact-phone">${contact.phone_number}</div>
                        <div class="contact-email">${contact.email || ''}</div>
                    </div>
                </div>
                <div class="contact-actions">
                    <button class="edit-btn" data-phone="${contact.phone_number}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="delete-btn" data-phone="${contact.phone_number}">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `;
            contactsListDiv.appendChild(contactItem);
        });
    }

    // Function to add a new contact
    async function addContact() {
        const phoneNumber = newContactPhoneInput.value.trim();
        const name = newContactNameInput.value.trim();
        const email = newContactEmailInput.value.trim();
        const city = newContactCityInput.value.trim();
        const tags = newContactTagsInput.value.trim();
        if (!phoneNumber || !name) {
            alert('Phone number and name are required.');
            return;
        }

        try {
            const response = await fetch('/api/contacts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phone_number: phoneNumber, name: name, email: email, city: city, tags: tags })
            });
            const result = await response.json();
            
            if (result.status === 'success') {
                showSuccessToast('Contact added successfully');
                newContactPhoneInput.value = '';
                newContactNameInput.value = '';
                newContactEmailInput.value = '';
                newContactCityInput.value = '';
                newContactTagsInput.value = '';
                fetchContacts();
            } else {
                alert(result.message);
            }
        } catch (error) {
            console.error('Error adding contact:', error);
            alert('An error occurred while adding the contact.');
        }
    }

    // Function to update a contact
    async function updateContact() {
        const originalPhone = editContactPhoneOriginal.value;
        const newName = editContactNameInput.value;
        const newEmail = editContactEmailInput.value;
        const newCity = editContactCityInput.value;
        const newTags = editContactTagsInput.value;
        const newNotes = editContactNotesInput.value;

        try {
            const response = await fetch(`/api/contacts/${originalPhone}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: newName,
                    email: newEmail,
                    city: newCity,
                    tags: newTags,
                    notes: newNotes
                })
            });
            const result = await response.json();
            
            if (result.status === 'success') {
                showSuccessToast('Contact updated successfully');
                hideModal(editModal);
                fetchContacts();
            } else {
                alert(result.message);
            }
        } catch (error) {
            console.error('Error updating contact:', error);
            alert('An error occurred while updating the contact.');
        }
    }

    // Function to delete a contact
    async function deleteContact(phoneNumber) {
        showConfirmModal(`Are you sure you want to delete contact ${phoneNumber}?`, async () => {
            try {
                const response = await fetch(`/api/contacts/${phoneNumber}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    showSuccessToast('Contact deleted successfully');
                    fetchContacts();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('Error deleting contact:', error);
                alert('An error occurred while deleting the contact.');
            }
        });
    }
    
    // Event Listeners
    sendMessageBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // Contact management event listeners
    showContactsBtn.addEventListener('click', () => {
        contactsPanel.classList.remove('hidden');
        fetchContacts();
    });
    
    showInboxBtn.addEventListener('click', () => {
        contactsPanel.classList.add('hidden');
    });

    addContactBtn.addEventListener('click', addContact);
    
    // Search input listener
    contactSearchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filteredContacts = allContacts.filter(contact =>
            contact.name.toLowerCase().includes(searchTerm) ||
            contact.phone_number.includes(searchTerm)
        );
        displayContacts(filteredContacts);
    });

    // Event delegation for edit and delete buttons
    contactsListDiv.addEventListener('click', (e) => {
        if (e.target.closest('.delete-btn')) {
            const btn = e.target.closest('.delete-btn');
            const phoneNumber = btn.dataset.phone;
            deleteContact(phoneNumber);
        }
        if (e.target.closest('.edit-btn')) {
            const btn = e.target.closest('.edit-btn');
            const phoneNumber = btn.dataset.phone;
            const contactToEdit = allContacts.find(c => c.phone_number === phoneNumber);
            if (contactToEdit) {
                editContactPhoneOriginal.value = contactToEdit.phone_number;
                editContactPhoneInput.value = contactToEdit.phone_number;
                editContactNameInput.value = contactToEdit.name;
                editContactEmailInput.value = contactToEdit.email;
                editContactCityInput.value = contactToEdit.city;
                editContactTagsInput.value = contactToEdit.tags;
                editContactNotesInput.value = contactToEdit.notes;
                showModal(editModal);
            }
        }
    });

    saveEditBtn.addEventListener('click', updateContact);
    cancelEditBtn.addEventListener('click', () => {
        hideModal(editModal);
    });

    // Automatically refresh inbox every 5 seconds
    setInterval(fetchChatList, 5000);

    // Initial page load
    fetchChatList();
</script>
{% endblock %}
